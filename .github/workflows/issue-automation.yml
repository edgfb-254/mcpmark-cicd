name: Issue Management Automation

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: write
  contents: read

jobs:
  issue-triage:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    outputs:
      issue_number: ${{ github.event.issue.number }}
      issue_title: ${{ github.event.issue.title }}
      issue_body: ${{ github.event.issue.body }}
      is_epic: ${{ steps.check_epic.outputs.is_epic }}
      priority_label: ${{ steps.determine_priority.outputs.priority_label }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Auto-assign category labels
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.issue;
            const title = context.payload.issue.title.toLowerCase();
            const labelsToAdd = [];
            
            // Add needs-triage label to all new issues
            labelsToAdd.push('needs-triage');
            
            // Check for category keywords in title
            if (title.includes('bug')) {
              labelsToAdd.push('bug');
            }
            if (title.includes('epic')) {
              labelsToAdd.push('epic');
            }
            if (title.includes('maintenance')) {
              labelsToAdd.push('maintenance');
            }
            
            // Add labels if any were found
            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labelsToAdd
              });
              console.log(`Added labels: ${labelsToAdd.join(', ')}`);
            }

      - name: Check if issue is epic
        id: check_epic
        run: |
          TITLE="${{ github.event.issue.title }}"
          if echo "$TITLE" | grep -qi "epic"; then
            echo "is_epic=true" >> $GITHUB_OUTPUT
          else
            echo "is_epic=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine priority based on keywords
        id: determine_priority
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.issue.title.toLowerCase();
            const body = context.payload.issue.body ? context.payload.issue.body.toLowerCase() : '';
            const combinedText = title + ' ' + body;
            
            let priorityLabel = 'priority-medium'; // default
            
            // Check for critical priority keywords (highest priority wins)
            const criticalKeywords = ['critical', 'urgent', 'production', 'outage'];
            const highKeywords = ['important', 'high', 'blocking'];
            const lowKeywords = ['low', 'nice-to-have', 'minor'];
            
            if (criticalKeywords.some(keyword => combinedText.includes(keyword))) {
              priorityLabel = 'priority-critical';
            } else if (highKeywords.some(keyword => combinedText.includes(keyword))) {
              priorityLabel = 'priority-high';
            } else if (lowKeywords.some(keyword => combinedText.includes(keyword))) {
              priorityLabel = 'priority-low';
            }
            
            // Add priority label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [priorityLabel]
            });
            
            console.log(`Added priority label: ${priorityLabel}`);
            core.setOutput('priority_label', priorityLabel);

  task-breakdown:
    runs-on: ubuntu-latest
    needs: issue-triage
    if: needs.issue-triage.outputs.is_epic == 'true' && github.event.action == 'opened'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create sub-issues for epic
        uses: actions/github-script@v7
        with:
          script: |
            const parentIssueNumber = context.issue.number;
            const parentTitle = context.payload.issue.title;
            const cleanTitle = parentTitle.replace(/^epic:\s*/i, '').trim();
            
            const taskNames = [
              'Requirements Analysis',
              'Design and Architecture', 
              'Implementation',
              'Testing and Documentation'
            ];
            
            const subIssueNumbers = [];
            
            // Create 4 sub-issues
            for (let i = 0; i < taskNames.length; i++) {
              const taskNumber = i + 1;
              const subIssueTitle = `[SUBTASK] ${cleanTitle} - Task ${taskNumber}: ${taskNames[i]}`;
              const subIssueBody = `Related to #${parentIssueNumber}\n\n## Task Description\n${taskNames[i]} for: ${cleanTitle}\n\n## Acceptance Criteria\n- [ ] Complete ${taskNames[i]}\n- [ ] Document findings and decisions`;
              
              try {
                const subIssue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: subIssueTitle,
                  body: subIssueBody,
                  labels: ['enhancement', 'needs-review']
                });
                
                subIssueNumbers.push(subIssue.data.number);
                console.log(`Created sub-issue #${subIssue.data.number}: ${subIssueTitle}`);
              } catch (error) {
                console.error(`Failed to create sub-issue ${taskNumber}:`, error);
              }
            }
            
            // Update parent issue with checklist
            if (subIssueNumbers.length > 0) {
              const parentIssue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parentIssueNumber
              });
              
              const currentBody = parentIssue.data.body || '';
              const epicTasksSection = `\n\n## Epic Tasks\n${subIssueNumbers.map(num => `- [ ] #${num}`).join('\n')}`;
              const newBody = currentBody + epicTasksSection;
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parentIssueNumber,
                body: newBody
              });
              
              console.log(`Updated parent issue #${parentIssueNumber} with epic tasks checklist`);
            }

  auto-response:
    runs-on: ubuntu-latest
    needs: issue-triage
    if: github.event.action == 'opened'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if first-time contributor
        id: check_first_time
        uses: actions/github-script@v7
        with:
          script: |
            const author = context.payload.issue.user.login;
            const issueNumber = context.issue.number;
            
            try {
              // Get all issues created by this user in this repo
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                creator: author,
                state: 'all',
                per_page: 100
              });
              
              // Check if this is their first issue (only 1 issue found - the current one)
              const isFirstTime = issues.data.length === 1;
              
              if (isFirstTime) {
                // Add first-time-contributor label
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: ['first-time-contributor']
                });
                console.log(`Added first-time-contributor label for @${author}`);
              }
              
              core.setOutput('is_first_time', isFirstTime.toString());
              core.setOutput('author', author);
            } catch (error) {
              console.error('Error checking first-time contributor:', error);
              core.setOutput('is_first_time', 'false');
              core.setOutput('author', author);
            }

      - name: Post auto-response comment
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.issue;
            const issueData = context.payload.issue;
            const labels = issueData.labels.map(l => l.name);
            const isFirstTime = ${{ steps.check_first_time.outputs.is_first_time }};
            const author = '${{ steps.check_first_time.outputs.author }}';
            const priorityLabel = '${{ needs.issue-triage.outputs.priority_label }}';
            
            let commentBody = '';
            
            // Welcome message for first-time contributors
            if (isFirstTime) {
              commentBody += `## ðŸŽ‰ Welcome @${author}! \n\nThank you for opening your first issue in this repository! We appreciate your contribution.\n\n`;
            }
            
            // Issue-specific responses
            if (labels.includes('bug')) {
              commentBody += `## ðŸ› Bug Report Guidelines\n\nThank you for reporting this bug! Our team will review it shortly.\n\n**Next Steps:**\n- We'll verify the bug and its impact\n- We'll assign appropriate priority and milestone\n- We'll update you on the progress\n\n**Please ensure you've provided:**\n- Clear steps to reproduce\n- Expected vs actual behavior\n- Environment details\n- Screenshots if applicable\n\n`;
            } else if (labels.includes('epic')) {
              commentBody += `## ðŸš€ Feature Request Process\n\nThank you for submitting this epic feature request! This will be broken down into manageable tasks.\n\n**Next Steps:**\n- Our automation will create sub-tasks for this epic\n- Each sub-task will be tracked separately\n- We'll review the overall approach and provide feedback\n- We'll assign appropriate priority and milestone\n\n**Epic Management:**\n- This epic will be tracked with a checklist of sub-tasks\n- Each sub-task will go through our standard review process\n- We'll coordinate the implementation across all tasks\n\n`;
            } else if (labels.includes('maintenance')) {
              commentBody += `## ðŸ”§ Maintenance Guidelines\n\nThank you for identifying this maintenance need! Keeping the codebase healthy is crucial.\n\n**Next Steps:**\n- We'll review the maintenance task\n- We'll assess priority and impact\n- We'll schedule it appropriately\n- We'll update you on the timeline\n\n**Maintenance Categories:**\n- Code cleanup and refactoring\n- Dependency updates\n- Documentation improvements\n- Performance optimizations\n- Security updates\n\n`;
            } else {
              commentBody += `## ðŸ“‹ Issue Received\n\nThank you for submitting this issue! Our team will review it and provide feedback shortly.\n\n`;
            }
            
            // Add priority and milestone information
            commentBody += `## ðŸ“Š Issue Status\n\n- **Priority:** ${priorityLabel}\n- **Status:** needs-triage â†’ needs-review\n- **Reviewers:** Maintainers will be assigned shortly\n\n`;
            
            // Add milestone information for high/critical priority
            if (priorityLabel === 'priority-high' || priorityLabel === 'priority-critical') {
              commentBody += `## ðŸŽ¯ Milestone\n\nThis issue has been assigned to milestone **v1.0.0** due to its priority level.\n\n`;
            }
            
            commentBody += `---\n\nðŸ’¡ **Pro Tip:** You can track the progress of this issue by subscribing to notifications. We'll keep you updated on any changes!`;
            
            // Post the comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: commentBody
            });
            
            console.log('Posted auto-response comment');

      - name: Set milestone for high priority issues
        if: needs.issue-triage.outputs.priority_label == 'priority-high' || needs.issue-triage.outputs.priority_label == 'priority-critical'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            
            try {
              // Try to get existing milestone v1.0.0
              const milestones = await github.rest.issues.listMilestones({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open'
              });
              
              let milestoneNumber = null;
              const targetMilestone = milestones.data.find(m => m.title === 'v1.0.0');
              
              if (targetMilestone) {
                milestoneNumber = targetMilestone.number;
              } else {
                // Create milestone if it doesn't exist
                const newMilestone = await github.rest.issues.createMilestone({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'v1.0.0',
                  state: 'open'
                });
                milestoneNumber = newMilestone.data.number;
                console.log('Created milestone v1.0.0');
              }
              
              // Assign milestone to issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                milestone: milestoneNumber
              });
              
              console.log(`Assigned milestone v1.0.0 to issue #${issueNumber}`);
            } catch (error) {
              console.error('Error setting milestone:', error);
            }

      - name: Update status label
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            
            try {
              // Remove needs-triage label
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'needs-triage'
              }).catch(() => console.log('needs-triage label already removed or not present'));
              
              // Add needs-review label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['needs-review']
              });
              
              console.log('Updated status: needs-triage â†’ needs-review');
            } catch (error) {
              console.error('Error updating status labels:', error);
            }